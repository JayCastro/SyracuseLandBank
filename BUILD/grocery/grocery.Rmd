---
title: "Grocery"
author: "Christine Brown"
date: "April 19, 2017"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,  warning = F , message = F)
```
Set-Up
```{r}
#Load Packages
library( dplyr )
library( geojsonio )
library( ggmap )
library( maps )
library( maptools )
library( raster )
library( rgdal )
library( rgeos )
library( sp )
```


```{r}

#Get Grocery Data from Community Geography
dir.create("C:/Users/brown/Documents/Grad School/Fall 16/DDMII/SyracuseLandBank/DATA/RAW_DATA/Grocery")
setwd("C:/Users/brown/Documents/Grad School/Fall 16/DDMII/SyracuseLandBank/DATA/RAW_DATA/Grocery")
download.file("http://communitygeography.org/wp-content/uploads/2015/08/Supermarkets.shp_.zip", "supermarkets.zip" )
unzip( "supermarkets.zip" )
file.remove( "supermarkets.zip" )

#Change Original Data into Shapefile and Convert to CSV
grocery <- readShapePoints( fn="Supermarkets", proj4string=CRS("+proj=longlat +datum=WGS84") )
grocery <- as.data.frame( grocery, stringsAsFactors=FALSE )
setwd("C:/Users/brown/Documents/Grad School/Fall 16/DDMII/SyracuseLandBank/DATA/RAW_DATA")
write.csv(grocery, file = "grocery_raw.csv", row.names=FALSE)

#Delete Community Geography File because CSV Has All Information
unlink("C:/Users/brown/Documents/Grad School/Fall 16/DDMII/SyracuseLandBank/DATA/RAW_DATA/Grocery", recursive = TRUE)

#Clean Data
grocery$City <- ifelse( is.na( grocery$City ), as.character(grocery$ARC_City_1), as.character(grocery$City) )
grocery <- mutate( grocery, Address=paste( Location, City, "NY", ZipCode, sep=", " ) )
grocery <- grocery[ , c( "Supermarke", "Address" ) ]

#Geocode
grocery_coordinates <- suppressMessages( geocode( grocery$Address, messaging=F ) )
grocery <- cbind( grocery, grocery_coordinates )

#Get Tract Information
syr_tracts <- geojson_read( "https://raw.githubusercontent.com/christine-brown/SyracuseLandBank/master/SHAPEFILES/SYRCensusTracts.geojson", method="local", what="sp" )
syr_tracts <- spTransform( syr_tracts, CRS( "+proj=longlat +datum=WGS84" ) )

#Match to Census Tract
grocery_coordinates_SP <- SpatialPoints( grocery_coordinates, proj4string=CRS("+proj=longlat +datum=WGS84" ) )
grocery_tract <- over( grocery_coordinates_SP, syr_tracts )

grocery <- cbind( grocery, grocery_tract )
grocery <- filter( grocery, !is.na( INTPTLON10 ) )

#Export to CSV
setwd( "C:/Users/brown/Documents/Grad School/Fall 16/DDMII/SyracuseLandBank/DATA/PROCESSED_DATA" )
write.csv( grocery, file = "grocery_processed.csv", row.names=FALSE )

#Aggregate Data
grocery <- as.data.frame( table( grocery$NAME10 ) )
grocery$YEAR <- 2015
names( grocery ) <- c( "TRACT", "GROCERY", "YEAR" )

#Export to CSV
setwd( "C:/Users/brown/Documents/Grad School/Fall 16/DDMII/SyracuseLandBank/DATA/AGGREGATED_DATA" )
write.csv( grocery, file = "grocery_aggregated.csv", row.names=FALSE )

#Create Buffers
syr_outline <- gBuffer( syr_tracts, width=.000, byid=F )
buff_half <- gBuffer( grocery_coordinates_SP, width=.0095, byid=F )
buff_half_clipped <- gIntersection(syr_outline, buff_half, byid=TRUE, drop_lower_td=T)
buff_one <- gBuffer( grocery_coordinates_SP, width=.019, byid=F)
buff_one_clipped <- gIntersection(syr_outline, buff_one, byid=TRUE, drop_lower_td=T)

#Plot Buffers
par(mar=c(0,0,0,0))
plot(syr_tracts, col="gray80")
plot(buff_one_clipped, col=rgb( 49, 109, 206, 60, maxColorValue=255), border=F, add=T)
plot(buff_half_clipped, col=rgb( 60, 120, 230, 80, maxColorValue=255), border=F, add=T)
points(grocery_coordinates, pch=19, col="white")
map.scale( x=-76.19555, y=43.00157, metric=F, ratio=F, relwidth = 0.1, cex=1 )



```