---
title: "Aggregate the NPO Data"
author: "Francisco Santamarina"
date: "April 20, 2017"
output:
  html_document:
    df_print: paged
    keep_md: true
      
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set( message=F, warning=F )
```

In part 2 of step "02_Aggregate the NPO Data", we identified the census tract information of nonprofits located in Syracuse, New York that are contained in the NCCS data set. We will be using this census tract information to see the number of nonprofits per census tract over a multi-year basis. 

## 1. Load the geocoded NPO Data and shapefiles

Load the packages that you will need during this process
```{r}
library( dplyr )
library( geojsonio )
library( ggmap )
library( maps )
library( maptools )
library( raster )
library( rgdal )
library( rgeos )
library( reshape )  # This is key in part 3, from: https://www.r-bloggers.com/pivot-tables-in-r/
library( sp )
library( tools )
```


Set your working directory as appropriate, then download the .CSV file containing the census tract information.
```{r}
# Set your working directory
setwd("~/GitHub/DDM-II/SyracuseLandBank/DATA/AGGREGATED_DATA")

# Load the geocoded data from GitHub
npos <- read.csv( "https://raw.githubusercontent.com/christine-brown/SyracuseLandBank/master/DATA/AGGREGATED_DATA/NPO_Data_processed.csv", stringsAsFactors=FALSE )

```


## 2. Generate the base aggregated file of summed NPOs per census tract

**First**, we will create a dataframe of a table version of the FIPS ID, or geographical identifier, of the nonprofits. This will provide us with a summarized, unique listing of the various IDs. 
```{r}
# Create a dataframe of NPOs by census tract and year
npos_years <- as.data.frame( table( npos$GEOID10 , npos$npos_yr ) )
names( npos_years ) <- c( "TRACT", "YEAR", "NPOS")
npos_years$YEAR <- as.numeric( as.character( npos_years$YEAR ) )
```

**Second**, we need to sum the number of NPOs that are new each year, so that we create a comprehensive view of the number of NPOs. Please note that we are assuming that an NPO does not close in this situation. We will also be cleaning up the tract number, and removing tracts that, for whatever reason, do not have any NPOs across years.
```{r}
# Create a variable that contains a unique list of years
years <- as.numeric( as.factor( unique( npos_years$YEAR ) ) )

# This should be a loop going 1:n, where n = length of "years"

hold <- 0
for( n in 1:length( years ) ){
  
  npos_years %>% filter( YEAR <= years[n] ) -> hold
}
# for each census tract, sum the # of NPOs across years

npos_years %>% filter( YEAR <= years[1] ) -> consolidated %>% mutate( year2 = rowSums( npos_years[ , 1:2 ] ) )

# Create a matrix of the number of new nonprofits per census tract by year
npos_years_sum <- cast( npos_years, TRACT ~ YEAR )
#cast( npos_years, TRACT ~ YEAR ) %>% tbl_df -> npos_years_sum

# Add a new column to the matrix that sums the values for a given time period
npos_years_sum %>% mutate( year1 = rowSums( npos_years_sum[,2]))

for( n in 1:length( years ) ){
  varname[n] <- paste("year",n, sep="")
#  npos_years_sum %>% mutate( .data=npos_years_sum, varname = rowSums( npos_years_sum[ , 2:( n+1 ) ] ) ) -> hold
  mutate( .data=npos_years_sum, varname[n] = rowSums( npos_years_sum[ , 2:( n+1 ) ] ) ) -> hold
}


test <- function( df, n ) {
  varname <- paste( "year", n, sep="" )
  df[[varname]] <- mutate( .data=df, varname = rowSums( df[ , 2:( n+1 ) ] ) )
  return(df)
}
test( npos_years_sum,length(years))

cumsum(npos_years_sum[,2:8])

#Filter the npos on a given year
# count ( date, tract)
# create a table with the tract and the frequency
# mutate on the year, then add
# filter the NPOs that have <= the last year + 1, then add that count to the table via mutate
# there should be a column for each year that sums the new NPOs that appear in each census tract in a year

# Create a matrix of the number of new nonprofits per census tract by year
npos_years_sum <- cast( npos_years, TRACT ~ YEAR )


# Create a new variable that performs an accumulated sum for each year, across the row
## code provided by Iterator: https://stackoverflow.com/questions/7550383/calculating-cumulative-sum-for-each-row-in-r
mySum = t( apply( npos_years_sum,1,cumsum ) )

tracts <- as.numeric( as.character( npos_years_sum$TRACT ) )


# Add the tracts back into the summed matrix
mySum <- cbind( tracts, mySum )

mySum <- as.data.frame( mySum, row.names = FALSE)

colnames( mySum )[1] <- "TRACT"

# then rbind the appropriate columns into a new data frame so that you have a unique row per tract and year, with the count of cumulative NPOs per combination/row

# Bind the various rows together
npos_years <- rbind( 
                      cbind( mySum[,1], NewColumn=colnames(mySum[2]), mySum[,2]), 
                      cbind( mySum[,1], NewColumn=colnames(mySum[3]), mySum[,3]),  
                      cbind( mySum[,1], NewColumn=colnames(mySum[4]), mySum[,4]),
                      cbind( mySum[,1], NewColumn=colnames(mySum[5]), mySum[,5]),
                      cbind( mySum[,1], NewColumn=colnames(mySum[6]), mySum[,6]),
                      cbind( mySum[,1], NewColumn=colnames(mySum[7]), mySum[,7]),
                      cbind( mySum[,1], NewColumn=colnames(mySum[8]), mySum[,8])
                      )

colnames( npos_years ) <- c( "TRACT", "YEAR", "NPOS_SUM" )
npos_years <- as.data.frame( npos_years )

# Strip the Tract Number to only contain the last 4 digits of the geoID
npos_years$TRACT <- as.numeric(substring(npos_years$TRACT, 8,11 ) ) / 100 
head(npos_years)

# Remove the tracts that do not have NPOs in any years
###### Modify this code
npos_years <- npos_years[ npos_years$NPOS_SUM != 0, ]
```


**Third**, let's take the finalized NPO dataset and write it to a .CSV file, so that we can use it later as needed.

```{r}
# Generate a .CSV file that contains census tract information.
write.csv( npos_years, "NPO_Data_aggregated.csv", row.names=F )
```

**Please be aware that this dataset aggregates the number of nonprofits across years.** Investigation into the year variable generated in part 2 of step "02_Aggregate the NPO Data" shows us that there is a wide arrange of years. To be cautious, we should also generate a dataset that breaks out new NPOs across years.  Let's generate a third that breaks out cumulative NPOs across the key subsectors. We will do both of these things in part 3. 

## 3. Generate files for new NPOs per census tract across years and by type

**First**, we will create a dataframe that counts the number of new nonprofits per year, broken down by census tract. 
```{r}
# Create a dataframe of NPOs by census tract and year
npos_new <- as.data.frame( table( npos$GEOID10 , npos$npos_yr ) )


# Rename the columns
names( npos_new ) <- c( "TRACT", "YEAR", "NEW_NPOS" )


# Strip the Tract Number to only contain the last 4 digits of the geoID
npos_new$TRACT <- as.numeric(substring(npos_new$TRACT, 8,11 ) ) / 100


# Remove the tracts that do not have NPOs in a given year
npos_new <- npos_new[ npos_new$NPOS != 0, ]
```


To generate a matrix with a totals row, run the code below:
*Please note that this will override the dataframe value generated above*
```{r}
# Create a dataframe of NPOs by census tract and year
npos_new <- as.data.frame( table( npos$GEOID10 , npos$npos_yr ) )


# Rename the columns
names( npos_new ) <- c( "TRACT", "YEAR", "NEW_NPOS")


# Cast the data such that the number of nonprofits per geoID is broken out by year
npos_new <- cast( npos_new, TRACT ~ YEAR )


# Create a dataframe of the summed number of nonprofits per year, transposing the values to be horizontal rather than vertical. This is key to bind with the original npos_new dataframe
npo_new_sum <- as.data.frame( t( colSums( npos_new ) ) )


# Give this sum row the geoID of "Total
npo_new_sum <- cbind( "Total", npo_new_sum)


# Rename the column containing "Total" to match the appropriate column in the original npos_new dataframe
colnames( npo_new_sum )[1] <- "TRACT"


# Bind the Totals row to the npos_new dataframe
npos_new <- rbind( npos_new, npo_new_sum )


# Strip the Tract Number to only contain the last 4 digits of the geoID
npos_new$TRACT <- as.numeric(substring(npos_new$TRACT, 8,11 ) ) / 100


npos_new$TRACT[ is.na(npos_new$TRACT) == TRUE ] <- "Total"
# This next line does not actually work - the goal was to re-cast some values as numeric
npos_new[ 1:52, 1 ] <- as.numeric( npos_new[ 1:52, 1 ] )
```

**Second**, we will create a dataframe that breaks down the new nonprofits per census tract by subsector. The subsectors of nonprofits identified in the variable NTMAJ12 are:<br><br>

•	AR	Arts, culture, and humanities<br>
•	BH	Education, higher<br>
•	ED	Education<br>
•	EH	Hospitals<br>
•	EN	Environment<br>
•	HE	Health<br>
•	HU	Human services<br>
•	IN	International<br>
•	MU	Mutual benefit<br>
•	PU	Public and societal benefit<br>
•	RE	Religion<br>
•	UN	Unknown

Please note that, because there are no NPOs with a value of "UN" for ntmaj12, we do not have a column with that value, so we are dropping "Unknown" from the lines below that rename columns.

To generate a dataframe, run the code below:
```{r}
# Create a dataframe of the number of NPOs in each census tract by category
npos_sector <- as.data.frame( table( npos$GEOID10 , npos$ntmaj12 ) )


# Rename the columns
names( npos_sector ) <- c( "TRACT", "NPO_SECTOR", "NEW_NPOS")


# Strip the Tract Number to only contain the last 4 digits of the geoID
npos_sector$TRACT <- as.numeric(substring(npos_sector$TRACT, 8,11 ) ) / 100


# Remove the tracts that do not have NPOs in a given year
npos_sector <- npos_sector[ npos_sector$NPOS != 0, ]
```



To generate a matrix with a totals row, run the code below:
*Please note that this will override the dataframe value generated above*
```{r}
# Create a dataframe of the number of NPOs in each census tract by category
npos_sector <- as.data.frame( table( npos$GEOID10 , npos$ntmaj12 ) )


# Rename the columns
names( npos_sector ) <- c( "TRACT", "NPO_SECTOR", "NEW_NPOS")


# Cast the data such that the number of nonprofits per geoID is broken out by year
npos_sector <- cast( npos_sector, TRACT ~ NPO_SECTOR )


# Create a dataframe of the summed number of nonprofits per year, transposing the values to be horizontal rather than vertical. This is key to bind with the original npos_sector dataframe
npo_sector_sum <- as.data.frame( t( colSums( npos_sector ) ) )


# Give this sum row the geoID of "Total
npo_sector_sum <- cbind( "Total", npo_sector_sum)


# Rename the column containing "Total" to match the appropriate column in the original npos_sector dataframe
colnames( npo_sector_sum )[1] <- "TRACT"


# Bind the Totals row to the npos_sector dataframe
npos_sector <- rbind( npos_sector, npo_sector_sum )


# Rename the columns such that they match the full names of the subsectors
names( npos_sector ) <- c( "TRACT", "Arts_Culture", "Education_Higher", "Education", "Hospitals", "Environment", "Health", "Human Services", "International", "Mutual_Benefit", "Public_Societal_Benefit", "Religion" )


# Strip the Tract Number to only contain the last 4 digits of the geoID
npos_sector$TRACT <- as.numeric(substring(npos_sector$TRACT, 8,11 ) ) / 100


npos_sector$TRACT[ is.na(npos_sector$TRACT) == TRUE ] <- "Total"
# This next line does not actually work - the goal was to re-cast some values as numeric
npos_sector[ 1:52, 1 ] <- as.numeric( npos_sector[ 1:52, 1 ] )
```


**Finally**, let's take these two modified NPO datasets and write them to .CSV files, so that we can use it later as needed.

```{r}
# Generate a .CSV file that breaks down the number of NPOs by census tract and year.
## Confirm if you are writing a matrix or data frame with:  str( npos_new )
write.csv( npos_new, "NPO_Data_newOrgs_aggregated.csv", row.names=F )

# Generate a .CSV file that breaks down the number of NPOs by census tract and subsector.
## Confirm if you are writing a matrix or data frame with:  str( npos_sector )
write.csv( npos_sector, "NPO_Data_newOrgs_aggregated_by_subsector.csv", row.names=F )
```
